// Generated by CoffeeScript 1.12.6
var changeNick, cmdNames, command, connect, disconnect, mainLoop, nick, nicked, parse, sendText, show, validateSendText;

nicked = false;

nick = null;

connect = function(again) {
  if (again == null) {
    again = false;
  }
  if (again) {
    nick = window.prompt("Already used! Use another nickname:", "default_user1").replace("&", "&amp;").replace("<", "&lt;").replace("\"", "&quot;").replace("'", "&apos;").slice(0, 50);
  } else {
    nick = window.prompt("Set your nickname:", "default_user").replace("&", "&amp;").replace("<", "&lt;").replace("\"", "&quot;").replace("'", "&apos;").slice(0, 50);
  }
  return $.ajax("../connect", {
    type: "POST",
    data: JSON.stringify({
      nick: nick
    }),
    success: function(data, status, req) {
      var e;
      if (data.status === 1) {
        return connect(true);
      } else if (data.status === 2) {
        alert("Your IP is banned.");
        e = document.getElementById("inputs");
        return e.parent.removeChild(e);
      }
    },
    contentType: 'application/json'
  });
};

sendText = function() {
  var data, inputBox;
  if (!nicked) {
    return false;
  }
  inputBox = document.getElementById("textArea");
  data = inputBox.value;
  if (data === "") {
    return false;
  }
  inputBox.value = "";
  $.ajax("../sendchat", {
    type: "POST",
    data: JSON.stringify({
      text: data,
      nick: nick
    }),
    success: null,
    contentType: 'application/json'
  });
  return true;
};

changeNick = function() {
  var newNick, nickBox;
  if (!nicked) {
    return false;
  }
  nickBox = document.getElementById("commandParms");
  newNick = nickBox.value;
  if (newNick === "") {
    return false;
  }
  nickBox.value = "";
  $.ajax("../setnick", {
    type: "POST",
    data: JSON.stringify({
      newNick: newNick
    }),
    success: function(data, status, req) {
      console.log("[DEBUG] " + (JSON.stringify(data)));
      if (data["continue"]) {
        return nick = newNick;
      } else {
        return show("*** Can't change nick (server refused)");
      }
    },
    contentType: 'application/json'
  });
  return true;
};

cmdNames = ["msg", "help", "nick", "adminauth", "kick", "kickban", "unban", "getips", "userlist"];

command = function() {
  var commandName, data, inputBox, other, paramBox, pass, pwBox;
  commandName = document.getElementById("commandName").value;
  if (commandName === "msg") {
    inputBox = document.getElementById("commandParms");
    data = inputBox.value;
    if (data === "") {
      return;
    }
    inputBox.value = "";
    return $.ajax("../sendchat", {
      type: "POST",
      data: JSON.stringify({
        text: data,
        nick: nick
      }),
      success: null,
      contentType: 'application/json'
    });
  } else if (commandName === "nick") {
    return changeNick();
  } else if (commandName === "help") {
    return show("Commands available: " + (cmdNames.join(' ')));
  } else if (commandName === "adminauth") {
    pwBox = document.getElementById("commandParms");
    pass = pwBox.value;
    pwBox.value = "";
    if (pass === "") {
      return;
    }
    return $.ajax("../adminauth", {
      type: "POST",
      data: JSON.stringify({
        password: sha256.create().update(pass).hex()
      }),
      success: function(data, status, req) {
        if (data.success) {
          return show("*** Logged as admin succesfully.");
        } else {
          return show("*** Wrong password.");
        }
      },
      contentType: "application/json"
    });
  } else if (commandName === "kick") {
    paramBox = document.getElementById("commandParms");
    other = paramBox.value;
    paramBox.value = "";
    return $.ajax("../kick", {
      type: "POST",
      data: JSON.stringify({
        other: other
      }),
      success: function(data, status, req) {
        if (data.success) {
          return show("*** Kicked " + other + " succesfully.");
        } else {
          return show("*** Kick operation refused (" + other + " doesn't exist or you haven't authed as admin!).");
        }
      },
      contentType: "application/json"
    });
  } else if (commandName === "kickban") {
    paramBox = document.getElementById("commandParms");
    other = paramBox.value;
    paramBox.value = "";
    return $.ajax("../kickban", {
      type: "POST",
      data: JSON.stringify({
        banIP: other
      }),
      success: function(data, status, req) {
        if (data.success) {
          return show("*** Banned IP " + other + " succesfully.");
        } else {
          return show("*** Kickban operation refused (IP " + other + " doesn't exist or you haven't authed as admin!).");
        }
      },
      contentType: "application/json"
    });
  } else if (commandName === "getips") {
    paramBox = document.getElementById("commandParms");
    other = paramBox.value;
    paramBox.value = "";
    return $.ajax("../getips", {
      type: "POST",
      data: JSON.stringify({
        other: other
      }),
      success: function(data, status, req) {
        if (data.success) {
          return show("*** " + other + " IPs: " + (data.ips.join(', ')) + ".");
        } else {
          return show("*** IP retrieval operation refused (" + other + " doesn't exist or you haven't authed as admin!).");
        }
      },
      contentType: "application/json"
    });
  } else if (commandName === "unban") {
    paramBox = document.getElementById("commandParms");
    other = paramBox.value;
    paramBox.value = "";
    return $.ajax("../unban", {
      type: "POST",
      data: JSON.stringify({
        banIP: other
      }),
      success: function(data, status, req) {
        if (data.success) {
          return show("*** Unbanned IP " + other + " succesfully.");
        } else {
          return show("*** Unban operation refused (IP " + other + " doesn't exist or you haven't authed as admin!).");
        }
      },
      contentType: "application/json"
    });
  } else if (commandName === "userlist") {
    return $.ajax("../userlist", {
      type: "POST",
      data: JSON.stringify(),
      success: function(data, status, req) {
        show("*** Users: " + (data.users.join(' ')));
        return show("*** Admins: " + (data.admins.join(' ')));
      },
      contentType: "application/json"
    });
  } else {
    return show("*** Invalid command. Try 'help' on the bottom left text box for more commands!");
  }
};

show = function(text) {
  return parse([
    {
      text: text,
      highlight: false,
      nick: "__noNick__"
    }
  ]);
};

validateSendText = function(event) {
  if (event.keyCode === 13) {
    return sendText();
  }
};

parse = function(logs) {
  var _l, d, i, len, pt, results;
  results = [];
  for (i = 0, len = logs.length; i < len; i++) {
    d = logs[i];
    if ((d.text != null) && d.text !== "") {
      if (new RegExp("\\&lt;[^>]*\\&gt;", "i").test(d.text)) {
        pt = new RegExp("\\&lt;[^>]*\\&gt;", "i").exec(d.text)[0];
        _l = pt.length + 1;
        d.text = d.text.slice(_l, d.text.length);
        d.text = d.text.replace(new RegExp("[a-zA-Z1-9]+\\:\\/\\/[^ \\)]+", "ig"), function(x) {
          return "<turl>" + x + "</turl>";
        });
        d.text = d.text.replace(new RegExp("img\\(\\<turl\\>[a-zA-Z1-9]+\\:\\/\\/[^\\<]+\\<\\/turl\\>\\)", "ig"), function(x) {
          var url;
          url = x.slice(10, x.length - 8);
          return "<a href=\"" + url + "\"><img src=\"" + url + "\"></a>";
        });
        d.text = d.text.replace(new RegExp("\\<turl\\>([^\\<]+)\\<\\/turl\\>", "ig"), function(x) {
          return "<a href=\"" + (x.slice(6, x.length - 7)) + "\">" + (x.slice(6, x.length - 7)) + "</a>";
        });
        d.text = pt + " " + d.text;
      }
      if (d.text.indexOf(nick) !== -1 && d.highlight && d.nick !== nick) {
        new Audio("../highlight.wav").play();
        d.text = d.text.replace(new RegExp(nick, "g"), '<span class="highlight"><span id="nick" /></span>').replace('<span id="nick" />', nick);
      }
      console.log(d.text);
      results.push(document.getElementById("logs").innerHTML += "</br>" + d.text);
    } else {
      results.push(void 0);
    }
  }
  return results;
};

mainLoop = function() {
  var scroll;
  scroll = document.getElementById("logs").scrollTop === (document.getElementById("logs").scrollHeight - document.getElementById("logs").offsetHeight);
  return $.ajax("../getchat", {
    type: "POST",
    data: JSON.stringify({
      nick: nick
    }),
    success: function(data, status, req) {
      if ((data["continue"] != null) && data["continue"]) {
        if (data.logs != null) {
          parse(data.logs);
          window.setTimeout(mainLoop, data.next * 1000);
        } else {
          window.setTimeout(mainLoop, 5000);
        }
      } else {
        disconnect();
        show("You have disconnected.");
      }
      if (scroll) {
        return document.getElementById("logs").scrollTop = document.getElementById("logs").scrollHeight - document.getElementById("logs").offsetHeight;
      }
    },
    contentType: 'application/json'
  });
};

disconnect = function() {
  document.getElementById("inputs").parentNode.removeChild(document.getElementById("inputs"));
  $.ajax("../disconnect", {
    type: "POST",
    data: JSON.stringify({
      nick: nick
    }),
    success: null,
    contentType: 'application/json'
  });
  return document.getElementById("logs").innerHTML += "</br>--- Disconnected.";
};

window.onload = function() {
  connect();
  nicked = true;
  return window.setTimeout(mainLoop, 1000);
};
